<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1"><!-- maximum-scale=1, user-scalable=no -->
        <title>Fancy Random Name Generator</title>
        <link href="static/bootstrap-3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="static/bootstrap-3.2.0/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
        <link href="static/bootstrap-select-1.6.2/css/bootstrap-select.min.css" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
        <style>
            body {
                margin: 1em;
                color: #333;
                background-color: #ccc;
                font-family: "Open Sans", sans-serif;
                font-size: 11pt;
            }
            h2 {
                display: inline-block;
                text-decoration: underline;
                margin: 0 15px 8px 0;
            }
            h3 {
                font-size: 12pt;
                font-style: italic;
                font-weight: bold;
                margin: 5px 0;
            }
            h2 + span > .btn {
                margin-bottom: 10px;
            }
            input.form-control {
                display: inline-block;
            }
            input[type="text"] {
                height: 24px;
                padding: 1px 3px;
            }
            tr:nth-child(even),
            li:nth-child(even) {
                background-color: #eee;
            }
            ul {
                padding: 0;
                list-style-type: none;
            }
            td {
                padding: 5px 8px;
            }

            .clear {
                clear: both;
            }
            .block {
                padding: 1em;
                background-color: #fff;
                -webkit-box-shadow: 2px 2px 2px rgba(0,0,0,.25);
                -moz-box-shadow: 2px 2px 2px rgba(0,0,0,.25);
                box-shadow: 2px 2px 2px rgba(0,0,0,.25);
            }
            .block:not(:first-child) {
                margin-top: 1em;
            }
            .row:not(:first-child) {
                margin-top: 20px;
            }

            #seed-names {
                height: 120px;
                width: 373px;
                resize: none;
            }
            #amount,
            #min-frequency,
            #min-inner {
                width: 40px;
            }
            #leads-list,
            #inners-list,
            #tails-list,
            #results-list {
                width: 100%;
            }

            .chunk {
                border: 1px solid #999;
                background: #fff;
                cursor: pointer;
                padding: 0 3px;
            }
            .chunk:hover {
                border: 1px solid #9acfea;
            }
            .chunk.include {
                border: 1px solid #b2dba1;
                background: #dff0d8;
            }
            .chunk.include:hover {
                border: 1px solid #5b5;
            }
            .chunk.exclude {
                border: 1px solid #dca7a7;
                background: #f2dede
            }
            .chunk.exclude:hover {
                border: 1px solid #b55;
            }
            .chunk:not(:first-child) {
                margin-left: 5px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <span class="column col-md-6">
                <div class="block" id="names-block">
                    <div>
                        <h2>Seeds</h2>
                        <select id="presets" name="presets" class="selectpicker" data-style="btn-default btn-xs" data-width="180px" data-show-subtext="true">
                            <option value="default">Presets</option>
                            <optgroup label="English">
                                <option value="en-male" data-subtext="English">Male</option>
                                <option value="en-female" data-subtext="English">Female</option>
                            </optgroup>
                            <optgroup label="Middle-earth">
                                <option value="me-hobbits" data-subtext="Middle-earth">Hobbits</option>
                                <option value="me-men" data-subtext="Middle-earth">Men</option>
                                <option value="me-dwarves" data-subtext="Middle-earth">Dwarves</option>
                                <option value="me-elves" data-subtext="Middle-earth">Elves</option>
                                <option value="me-various" data-subtext="Middle-earth">Various</option>
                            </optgroup>
                            <optgroup label="Game of Thrones">
                                <option value="got-male" data-subtext="Game of Thrones">Male</option>
                                <option value="got-female" data-subtext="Game of Thrones">Female</option>
                            </optgroup>
                            <optgroup label="Harry Potter">
                                <option value="hp-male" data-subtext="Harry Potter">Male</option>
                                <option value="hp-female" data-subtext="Harry Potter">Female</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <textarea id="seed-names" name="seed-names" class="form-control"></textarea>
                    </div>
                </div>
                <form class="block" id="seed-options-block">
                    <div>
                        <h2>Options</h2>
                        <span>
                            <button type="reset" class="btn btn-default btn-xs"><!-- btn-danger -->
                                <span class="glyphicon glyphicon-repeat"></span> Reset
                            </button>
                        </span>
                    </div>
                    <div>
                        <input id="amount" name="amount" type="text" value="10" class="form-control"/>
                        <label for="amount">Amount to generate</label>
                    </div>
                    <div>
                        <input id="min-inner" name="min-inner" type="text" value="0" class="form-control"/>
                        <label for="min-inner">Minimum inner chunks</label>
                    </div>
                    <div>
                        <input id="min-frequency" name="min-frequency" type="text" value="1" class="form-control"/>
                        <label for="min-frequency">Minimum chunk frequency</label>
                    </div>
                </form>
                <div class="block" id="chunks-block">
                    <div>
                        <h2>Chunks</h2>
                        <span>
                            <button id="add-chunks" type="button" class="btn btn-primary btn-xs">
                                <span class="glyphicon glyphicon-arrow-down"></span> Add Chunks
                            </button>
                            <button id="clear-chunks" type="button" class="btn btn-default btn-xs">
                                <span class="glyphicon glyphicon-remove"></span> Clear
                            </button>
                        </span>
                    </div>
                    <div>
                        <span class="col-md-4">
                            <h3>Leads</h3>
                            <table id="leads-list" data-chunk-type=0>
                                <tr><td colspan=2><i>None</i></td></tr>
                            </table>
                        </span>
                        <span class="col-md-4">
                            <h3>Inners</h3>
                            <table id="inners-list" data-chunk-type=1>
                                <tr><td colspan=2><i>None</i></td></tr>
                            </table>
                        </span>
                        <span class="col-md-4">
                            <h3>Tails</h3>
                            <table id="tails-list" data-chunk-type=2>
                                <tr><td colspan=2><i>None</i></td></tr>
                            </table>
                        </span>
                    </div>
                    <div class="clear"></div>
                </div>
            </span>
            <span class="column col-md-6">
                <div class="block" id="results-block">
                    <div>
                        <h2>Results</h2>
                        <span>
                            <button id="generate" type="button" class="btn btn-primary btn-xs">
                                <span class="glyphicon glyphicon-arrow-down"></span> Generate
                            </button>
                            <button id="clear-results" type="button" class="btn btn-default btn-xs">
                                <span class="glyphicon glyphicon-remove"></span> Clear
                            </button>
                        </span>
                    </div>
                    <table id="results-list">
                        <tr><td colspan=2><i>None, generate some!</i></td></tr>
                    </table>
                    <div id="message"></div>
                </div>
            </span>
        </div>
        <script src="static/jquery-1.11.1.js" type="text/javascript"></script>
        <script src="static/underscore-1.7.0.js" type="text/javascript"></script>
        <!-- TODO: set back to jquery.min.js -->
        <script src="static/bootstrap-3.2.0/js/bootstrap.js" type="text/javascript"></script>
        <script src="static/bootstrap-select-1.6.2/js/bootstrap-select.js" type="text/javascript"></script>
        <script type="text/javascript">
            // The basic idea for this was mostly adapted from the
            //   blog post "Random Name Generation" by Jim Storch
            //  http://bogboa.blogspot.com/2009/12/random-name-generation.html
            //  (it's nicer in Python)

            // Globals
            chunks = [{}, {}, {}];
            include = [[], [], []];
            exclude = [[], [], []];
            results = [];

            // A big ol' block o' names
            presets = {
                "default": "Alex Bobby Charlie Doug Edward Francis Gabriel Harold Ian James Kevin Larry Michael Nathan Oswald Peter Quincy Romeo Stephen Travis Usher Victor William Xavier Yancy Zack",
                "en-male": "english men",
                "en-female": "english women",
                "me-hobbits": "me hobbits",
                "me-men": "me men",
                "me-dwarves": "me dorfs",
                "me-elves": "me elfmans",
                "me-various": "me mixed",
                "got-male": "got dudes?",
                "got-female": "got dames?",
                "hp-male": "hp boys",
                "hp-female": "hp ladiez",
            };

            // Because JavaScript doesn't have this??
            function random_int(min, max) {
                return Math.floor(Math.random() * (max - min + 1) + min);
            }

            function get_chunks_from_name(name) {
                var lead = /^[aeiouy]*(?:qu|[bcdfghjklmnpqrstvwxz])+/;
                var inner = /\B[aeiouy]+(?:qu|[bcdfghjklmnpqrstvwxz])+\B/g;
                var tail = /[aeiouy]+(?:qu|[bcdfghjklmnpqrstvwxz])*$/;
                name = name.toLowerCase();
                return [name.match(lead), name.match(inner), name.match(tail)];
            }

            function make_chunks(seed_names) {
                if (seed_names.length < 1) {
                    return;
                }
                $.each(seed_names, function(index, name) {
                    var new_chunks = get_chunks_from_name(name);
                    var chunk;
                    if (new_chunks[0]) {
                        chunk = new_chunks[0][0];
                        chunks[0][chunk] = (chunks[0][chunk] || 0) + 1;
                    }
                    if (new_chunks[1]) {
                        $.each(new_chunks[1], function(index, chunk) {
                            chunks[1][chunk] = (chunks[1][chunk] || 0) + 1;
                        });
                    }
                    if (new_chunks[2]) {
                        chunk = new_chunks[2][0];
                        chunks[2][chunk] = (chunks[2][chunk] || 0) + 1;
                    }
                });
            }

            function update_chunk_list(list_id, new_chunks) {
                var html = "";
                $.each(new_chunks, function(chunk, count) {
                    html += '<tr><td><span class="chunk">' + chunk + "</span></td><td>" + count + "</td></tr>";
                });
                if (html == "") {
                    html = "<tr><td colspan=2><i>None</i></td></tr>";
                }
                $("#" + list_id).html(html);
            }

            function update_chunk_lists() {
                update_chunk_list("leads-list", chunks[0]);
                update_chunk_list("inners-list", chunks[1]);
                update_chunk_list("tails-list", chunks[2]);
            }

            function make_chunk_pool(chunk_type, min_frequency) {
                var pool = [];
                $.each(chunks[chunk_type], function(chunk, count) {
                    if (include[chunk_type].length) {
                        if (include[chunk_type].indexOf(chunk) < 0) {
                            return;
                        }
                    }
                    else if (exclude[chunk_type].indexOf(chunk) >= 0) {
                        return;
                    }
                    if (count >= min_frequency) {
                        pool.push(chunk);
                    }
                });
                return pool;
            }

            function make_names(amount, min_inner, min_frequency, weighted) {
                amount = typeof amount != 'undefined' ? amount : 10;
                min_inner = typeof min_inner != 'undefined' ? min_inner : 0;
                min_frequency = typeof min_frequency != 'undefined' ? min_frequency : 1;
                weighted = typeof weighted != 'undefined' ? weighted : false;
                // Build our chunks pools based on the given options
                var lead_pool = make_chunk_pool(0, min_frequency);
                var inner_pool = make_chunk_pool(1, min_frequency);
                var tail_pool = make_chunk_pool(2, min_frequency);
                // Make sure we've got enough chunks to work with
                if (lead_pool.length < 1 || tail_pool.length < 1) {
                    return [];
                }
                if (min_inner > 0 && inner_pool.length < 1) {
                    return [];
                }
                // We're good, now make us some names!
                var new_names = [];
                // todo: filtering duplicate names
                for (var i = 0; i < amount; i++) {
                    // 50% chance of 1 inner chunk (3 total with lead and tail)
                    var random_inners = random_int(0, 1);
                    // 15% chance of another inner chunk (4 total)
                    if (Math.random() > 0.85) {
                        random_inners += 1;
                    }
                    // Make sure we've got enough
                    random_inners = Math.max(random_inners, min_inner);
                    // Now make a name!
                    var lead_used = lead_pool[random_int(0, lead_pool.length - 1)];
                    var name = lead_used;
                    var inners_used = [];
                    for (var j = 0; j < random_inners; j++) {
                        inners_used.push(inner_pool[random_int(0, inner_pool.length - 1)]);
                    }
                    name += inners_used.join("");
                    var tail_used = tail_pool[random_int(0, tail_pool.length - 1)]
                    name += tail_used;
                    name = name.charAt(0).toUpperCase() + name.slice(1);
                    name_array = [name, lead_used, inners_used, tail_used];
                    results.push(name_array);
                    new_names.push(name_array);
                }
                return new_names;
            }

            function update_results_list() {
                var html = "";
                $.each(results, function(index, name_array) {
                    name = name_array[0];
                    html += "<tr><td>" + name + "</td><td>";
                    html += '<span class="chunk">' + name_array[1] + "</span>";
                    $.each(name_array[2], function(chunk_index, chunk) {
                        html += '<span class="chunk">' + chunk + "</span>";
                    });
                    html += '<span class="chunk">' + name_array[3] + "</span>";
                    html += "</td></tr>";
                });
                if (html == "") {
                    html = "<tr><td colspan=2><i>None, generate some!</i></td></tr>";
                }
                $("#results-list").html(html);
            }

            // Form processing stuff

            function change_preset(event) {
                var names = presets[$(this).val()];
                if (names != "") {
                    $("#seed-names").val(names);
                }
            }

            function click_add_chunks(event) {
                var seed_names = $("#seed-names").val()
                                                 .replace(/[\t\n\r]/g, " ")
                                                 .replace(/ +/g, " ");
                seed_names = $.trim(seed_names).split(" ");
                if (seed_names.length < 1 || seed_names[0] == "") {
                    return;
                }
                make_chunks(seed_names);
                update_chunk_lists();
            }

            function click_clear_chunks(event) {
                chunks = [{}, {}, {}];
                include = [[], [], []];
                exclude = [[], [], []];
                update_chunk_lists();
            }

            function click_chunk(event) {
                span = $(this);
                chunk_type = span.parents("table").data("chunk-type");
                chunk = span.text();
                if (span.hasClass("include")) {
                    // Cycle to exclude
                    include[chunk_type] = _.without(include[chunk_type], chunk)
                    if (exclude[chunk_type].indexOf(chunk) < 0) {
                        exclude[chunk_type].push(chunk)
                    }
                    span.removeClass("include");
                    span.addClass("exclude");
                }
                else if (span.hasClass("exclude")) {
                    // Cycle to normal
                    include[chunk_type] = _.without(include[chunk_type], chunk)
                    exclude[chunk_type] = _.without(exclude[chunk_type], chunk)
                    span.removeClass("exclude");
                }
                else {
                    // Cycle to include
                    if (include[chunk_type].indexOf(chunk) < 0) {
                        include[chunk_type].push(chunk)
                    }
                    exclude[chunk_type] = _.without(exclude[chunk_type], chunk)
                    span.addClass("include");
                }
            }

            function click_generate_results(event) {
                var amount = Number($("#amount").val());
                var min_inner = Number($("#min-inner").val());
                var min_frequency = Number($("#min-frequency").val());
                // These could be NaN from the Number conversion,
                //  so we're wrapping this in a NOT, because
                //  NaN < 0 returns false.
                if (!(amount >= 1)) {
                    // todo: some sort of error message/color
                    return;
                }
                if (!(min_inner >= 0)) {
                    // todo: some sort of error message/color
                    return;
                }
                if (!(min_frequency >= 0)) {
                    // todo: some sort of error message/color
                    return;
                }
                var new_names = make_names(amount, min_inner, min_frequency);
                update_results_list();
            }

            function click_clear_results(event) {
                results = [];
                update_results_list();
            }

            $(document).ready(function() {
                $("#presets")
                    .on("change", change_preset)
                    .selectpicker()
                    .trigger("change");
                $("#add-chunks").on("click", click_add_chunks);
                $("#clear-chunks").on("click", click_clear_chunks);
                $("#chunks-block").on("click", ".chunk", click_chunk);
                $("#generate").on("click", click_generate_results);
                $("#clear-results").on("click", click_clear_results);
            });
        </script>
    </body>
</html>
